---
title: "Limited generalizability of epigenetic measures: epigenetic clock cross-tissue correlations"
author: "Vera N. Karlbauer"
contact: "vera_karlbauer@psych.mpg.de"
date: "2024-12-10"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/vera_karlbauer/Documents/Kids2Health/02_stats/02_analysis/limited_generalizability_of_epigenetic_measures")
```

# What this script does:
- Correlate within-person Pearson correlations of epigenetic clocks between matched blood and saliva samples.
- Calculate correlations separately for uncorrected and celltype-residualized clocks.
- Calculate correlations separately for epigenetic age ("Age"), epigenetic age acceleration ("Accel", epigenetic age residualized for chronological age), and epigenetic age delta ("Delta", epigenetic age minus chronological age).
- For all correlations, also calculate corresponding ICC values (ICC2/random effects).
- Plot results as corrplots (left side of Figure 3).
- Export results as eTable 5.

# Setup
### Step 0: Load packages

```{r, include = FALSE}
# load packages
library(rmarkdown)
library(dplyr)
library(corrplot)
library(stringr)
library(RColorBrewer)
library(tibble)
library(tidyr)
library(writexl)
library(psych)
```

### Step 1: Source functions and utilities

```{r}
source("./00_functions/01_functions.R")
source("./00_functions/02_utilities.R")
```

### Step 2: Load data

```{r, include = FALSE}
load("../../../01_data/02_proc/09_cross_tissue/all_cross_tissue_inner.Rdata")
```

### Step 3: Subset data (T0 only, clocks only, with vs. without cell type correction)

```{r}
all_cross_tissue_inner <- all_cross_tissue_inner %>%
  filter(timepoint == "T0")
```

# Cross-tissue correlation of clocks 

## Calculate correlations with and without cell type correction

```{r}
## no cell type correction
# subset data
temp <- all_cross_tissue_inner %>%
  select(starts_with(c("epiage", "dunedin_pace"))) %>%
  select(!starts_with(c("epiage_accel_", "epiage_delta_", "epiage_telo_", "epiage_pc_telo_"))) %>%
  select(!contains("resid"))
# create correlation matrix
corrmat_age_nocelltypes <- cor(temp, use = "pairwise", method = "pearson")
# test for significance
pmat_age_nocelltypes <- cor.mtest(as.matrix(temp), conf.level = 0.95, method = "pearson", alternative = "two.sided", exact = FALSE, use = "pairwise")

## cell type correction
# subset data
temp <- all_cross_tissue_inner %>%
  select(starts_with(c("epiage", "dunedin_pace"))) %>%
  select(!starts_with(c("epiage_accel_", "epiage_delta_", "epiage_telo_", "epiage_pc_telo_"))) %>%
  select(contains("resid"))
# create correlation matrix
corrmat_age_celltypes <- cor(temp, use = "pairwise", method = "pearson")
# test for significance
pmat_age_celltypes <- cor.mtest(as.matrix(temp), conf.level = 0.95, method = "pearson", alternative = "two.sided", exact = FALSE, use = "pairwise")

```

# Cross-tissue correlation between acceleration estimates

## Calculate correlations with and without cell type correction

```{r}
## no cell type correction
# subset data
temp <- all_cross_tissue_inner %>%
  select(starts_with(c("epiage_accel_"))) %>%
  select(!starts_with(c("epiage_accel_telo_"))) %>%
  select(!contains("resid"))
# create correlation matrix
corrmat_accel_nocelltypes <- cor(temp, use = "pairwise", method = "pearson")
# test for significance
pmat_accel_nocelltypes <- cor.mtest(as.matrix(temp), conf.level = 0.95, method = "pearson", alternative = "two.sided", exact = FALSE, use = "pairwise")

## cell type correction
# subset data
temp <- all_cross_tissue_inner %>%
  select(starts_with(c("epiage_accel_"))) %>%
  select(!starts_with(c("epiage_accel_telo_"))) %>%
  select(contains("resid"))
# create correlation matrix
corrmat_accel_celltypes <- cor(temp, use = "pairwise", method = "pearson")
# test for significance
pmat_accel_celltypes <- cor.mtest(as.matrix(temp), conf.level = 0.95, method = "pearson", alternative = "two.sided", exact = FALSE, use = "pairwise")

```

# Cross-tissue correlation between epigenetic age - chronological age deltas

## Calculate correlations with and without cell type correction

```{r}
## no cell type correction
# subset data
temp <- all_cross_tissue_inner %>%
  select(starts_with(c("epiage_delta_"))) %>%
  select(!starts_with(c("epiage_delta_telo_"))) %>%
  select(!contains("resid"))
# create correlation matrix
corrmat_delta_nocelltypes <- cor(temp, use = "pairwise", method = "pearson")
# test for significance
pmat_delta_nocelltypes <- cor.mtest(as.matrix(temp), conf.level = 0.95, method = "pearson", alternative = "two.sided", exact = FALSE, use = "pairwise")

## cell type correction
# subset data
temp <- all_cross_tissue_inner %>%
  select(starts_with(c("epiage_delta_"))) %>%
  select(!starts_with(c("epiage_delta_telo_"))) %>%
  select(contains("resid"))
# create correlation matrix
corrmat_delta_celltypes <- cor(temp, use = "pairwise", method = "pearson")
# test for significance
pmat_delta_celltypes <- cor.mtest(as.matrix(temp), conf.level = 0.95, method = "pearson", alternative = "two.sided", exact = FALSE, use = "pairwise")
```

# Aggregate & plot cross-tissue correlations of clocks & acceleration estimates

## Aggregate data without cell type correction

```{r}
## without cell types
# format all correlation matrix diagonals of interest into table
# epiage
mat = corrmat_age_nocelltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_nocell <- as.matrix(diag(mat[rows, cols]))
rownames(corrmat_nocell) <- rows
# epiage accel
mat = corrmat_accel_nocelltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_nocell <- cbind(corrmat_nocell,
                    c(diag(mat[rows, cols]),NA))
# epiage delta
mat = corrmat_delta_nocelltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_nocell <- cbind(corrmat_nocell,
                    c(diag(mat[rows, cols]),NA))
# fix row/col names
colnames(corrmat_nocell) <- c("age", "accel", "delta")
rownames(corrmat_nocell) <- rename_clocks(rownames(corrmat_nocell))
# sort
corrmat_nocell <- corrmat_nocell[clockorder, ]

# format all p-value matrix diagonals of interest into table
# epiage
mat = pmat_age_nocelltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_nocell <- as.matrix(diag(mat[rows, cols]))
rownames(pmat_nocell) <- rows
# epiage accel
mat = pmat_accel_nocelltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_nocell <- cbind(pmat_nocell,
                  c(diag(mat[rows, cols]), NA))
# epiage delta
mat = pmat_delta_nocelltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_nocell <- cbind(pmat_nocell,
                  c(diag(mat[rows, cols]), NA))
# fix row/col names
colnames(pmat_nocell) <- c("age", "accel", "delta")
rownames(pmat_nocell) <- rename_clocks(rownames(pmat_nocell))
# sort
pmat_nocell <- pmat_nocell[clockorder,]
```

## Aggregate data with cell type correction

```{r}
## with celltypes
# format all correlation matrix diagonals of interest into table
# epiage
mat = corrmat_age_celltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_cell <- as.matrix(diag(mat[rows, cols]))
rownames(corrmat_cell) <- rows
# epiage accel
mat = corrmat_accel_celltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_cell <- cbind(corrmat_cell,
                    c(diag(mat[rows, cols]),NA))
# epiage delta
mat = corrmat_delta_celltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_cell <- cbind(corrmat_cell,
                    c(diag(mat[rows, cols]),NA))
# fix row/col names
colnames(corrmat_cell) <- c("age", "accel", "delta")
rownames(corrmat_cell) <- rename_clocks(rownames(corrmat_cell))
# sort
corrmat_cell <- corrmat_cell[clockorder, ]

# format all p-value matrix diagonals of interest into table
# epiage
mat = pmat_age_celltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_cell <- as.matrix(diag(mat[rows, cols]))
rownames(pmat_cell) <- rows
# epiage accel
mat = pmat_accel_celltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_cell <- cbind(pmat_cell,
                  c(diag(mat[rows, cols]), NA))
# epiage delta
mat = pmat_delta_celltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_cell <- cbind(pmat_cell,
                  c(diag(mat[rows, cols]), NA))
# fix row/col names
colnames(pmat_cell) <- c("age", "accel", "delta")
rownames(pmat_cell) <- rename_clocks(rownames(pmat_cell)) %>% str_replace("_resid", "")
# sort
pmat_cell <- pmat_cell[clockorder,]  
```

## Create combined correlation plot (Figure 3A)

```{r}
### create combined corrplot
# initialize graphics device
tiff(file = "04_figures/figure_3a_corrplot_all_epiage_measures_cross_tissue.png", height = 6.7, width = 5, units = 'in', res = 700)
par(mfrow=c(1,2),
    mar = c(1,1,1,1),
    oma = c(0,0,4,0))
# Plot 1: without cell types
par(xpd=TRUE)
corrplot(corr = corrmat_nocell,
         method = "color",
         type = "full",
         col = GyPr_palette,
         addCoef.col = "black",
         tl.col = "black",
         tl.cex = 1,
         tl.srt = 45,
         number.cex = 1,
         cl.pos = "n",
         p.mat = pmat_nocell,
         sig.level = 0.05,
         insig = "label_sig",
         pch = "      *",
         pch.col = "orange",
         pch.cex = 1.2,
         na.label = "NA",
         mar = c(0,0.2,0,1))
mtext("A               Blood-saliva correlations per clock", side=3, line=3, at = 3.5, cex = 1.2, font = 2)
mtext("without cell type correction", side=3, line=1, cex = 1, at = 1.5)
# Plot 2: with cell types
par(xpd=TRUE)
corrplot(corr = corrmat_cell,
         method = "color",
         type = "full",
         col = GyPr_palette,
         addCoef.col = "black",
         tl.col = "black",
         tl.cex = 1,
         tl.srt = 45,
         number.cex = 1,
         cl.pos = "n",
         # cl.ratio = 0.5,
         # cl.offset = 2,
         p.mat = pmat_cell,
         sig.level = 0.05,
         insig = "label_sig",
         pch = "      *",
         pch.col = "orange",
         pch.cex = 1.2,
         na.label = "NA", 
         mar = c(0,0.2,0,1))
mtext("with cell type correction", side=3, line=1, cex = 1, at = 1.5)

# shut off
dev.off()
```
## Export color scale

```{r}
# initialize graphics device
tiff(file = "04_figures/figure_3c_corrplot_cross_tissue_colorscale.png", height = 7, width = 10, units = 'in', res = 700)
# Placeholder plot with color scale
corrplot(corr = t(corrmat_nocell),
         method = "color",
         type = "full",
         col = GyPr_palette,
         addCoef.col = "black",
         tl.col = "black",
         tl.cex = 1,
         tl.srt = 45,
         number.cex = 1,
         cl.pos = "b",
         cl.ratio = 0.3,
         cl.offset = 0.3,
         p.mat = t(pmat_nocell),
         sig.level = 0.05,
         insig = "label_sig",
         pch = "       *",
         pch.col = "orange",
         pch.cex = 1.2,
         na.label = "NA")
dev.off()
```

## Prepare correlations for export & correct for multiple testing

```{r}
# reshape
# corrmat_nocell
corrmat_nocell <- as.data.frame(corrmat_nocell)
colnames(corrmat_nocell) <- paste0("cor_", colnames(corrmat_nocell))
corrmat_nocell <- corrmat_nocell %>%
  rownames_to_column(var = "epiclock")
# pmat_nocell
pmat_nocell <- as.data.frame(pmat_nocell)
colnames(pmat_nocell) <-paste0("p_", colnames(pmat_nocell))
pmat_nocell <- pmat_nocell %>%
  rownames_to_column(var = "epiclock")
# corrmat_cell
corrmat_cell <- as.data.frame(corrmat_cell) 
colnames(corrmat_cell) <- paste0("cor_", colnames(corrmat_cell), "_celltype_adjusted")
corrmat_cell <- corrmat_cell %>%
  rownames_to_column(var = "epiclock")
# pmat_cell
pmat_cell <- as.data.frame(pmat_cell) 
colnames(pmat_cell) <- paste0("p_", colnames(pmat_cell), "_celltype_adjusted")
pmat_cell <- pmat_cell %>%
  rownames_to_column(var = "epiclock")

# combine 
correlations_epiclocks <- full_join(corrmat_nocell, pmat_nocell, by = "epiclock")
correlations_epiclocks <- full_join(correlations_epiclocks, corrmat_cell, by = "epiclock")
correlations_epiclocks <- full_join(correlations_epiclocks, pmat_cell, by = "epiclock")
correlations_epiclocks <- pivot_longer(correlations_epiclocks,
    cols = c("cor_age", "cor_accel", "cor_delta", "p_age", "p_accel", "p_delta"),
    names_to = c(".value", "type"),
    names_pattern = "(cor|p)_(age|accel|delta)?")
correlations_epiclocks <- correlations_epiclocks %>%
  mutate(cor_celltype_adjusted = case_when(type == "age" 
                                           ~ cor_age_celltype_adjusted,
                                           type == "accel" 
                                           ~ cor_accel_celltype_adjusted,
                                           type == "delta" 
                                           ~ cor_delta_celltype_adjusted,
                                           TRUE ~ NA),
         p_celltype_adjusted = case_when(type == "age" 
                                           ~ p_age_celltype_adjusted,
                                           type == "accel" 
                                           ~ p_accel_celltype_adjusted,
                                           type == "delta" 
                                           ~ p_delta_celltype_adjusted,
                                           TRUE ~ NA))
correlations_epiclocks <- correlations_epiclocks %>%
  select(-c(cor_age_celltype_adjusted, cor_accel_celltype_adjusted, cor_delta_celltype_adjusted, p_age_celltype_adjusted, p_accel_celltype_adjusted, p_delta_celltype_adjusted)) 
correlations_epiclocks <- correlations_epiclocks %>%
  mutate(epiclock = paste0(epiclock, str_to_title(type)))
correlations_epiclocks <- correlations_epiclocks %>%
  select(-type) %>%
  filter(epiclock != "DunedinPACEAccel") %>%
  filter(epiclock != "DunedinPACEDelta") %>%
  mutate(epiclock = case_when(epiclock == "DunedinPACEAge" ~ "DunedinPACE", 
                              TRUE ~ epiclock))

# run FDR correction
correlations_epiclocks <- correlations_epiclocks %>%
  mutate(p_fdr = p.adjust(
    c(correlations_epiclocks$p, correlations_epiclocks$p_celltype_adjusted), method = "fdr")[1:length(correlations_epiclocks$p)],
         p_fdr_celltype_adjusted = p.adjust(
           c(correlations_epiclocks$p, correlations_epiclocks$p_celltype_adjusted),
           method = "fdr")[(length(correlations_epiclocks$p_celltype_adjusted)+1):(2*length(correlations_epiclocks$p_celltype_adjusted))])

# select relevant variables
correlations_epiclocks <- correlations_epiclocks %>%
  select(epiclock, cor, p, p_fdr, cor_celltype_adjusted, p_celltype_adjusted, p_fdr_celltype_adjusted) 

```

# Calculate cross-tissue ICCs of clocks & acceleration estimates

```{r}
# get names of all epigenetic aging measures
clocknames <- gsub("_blood", "",
  colnames(all_cross_tissue_inner %>%
  select(starts_with(c("epiage", "dunedin_pace"))) %>%
  select(!starts_with(c("epiage_telo_", "epiage_pc_telo_"))) %>%
    select(!contains("resid")) %>%
    select(!contains("saliva"))))
  
# define empty results object
icc_epiclocks <- as.data.frame(matrix(nrow = 7, ncol = 0))
# loop over all epiage measures
# for each epiage measure, calculate ICC2 (random effects) with and without cell type correction
for(i in 1:length(clocknames)) {
  clock = clocknames[i]
  icc_nocelltype = ICC(select(all_cross_tissue_inner, 
                        paste0(clock, "_blood"), paste0(clock, "_saliva")))
  icc_celltype = ICC(select(all_cross_tissue_inner,
                            paste0(clock, "_resid_blood"), paste0(clock, "_resid_saliva")))
  icc = as.data.frame(matrix(nrow = 1, ncol = 0))
  icc$name = clock
  icc$icc = filter(icc_nocelltype$results, type == "ICC2")$ICC
  icc$icc_lower = filter(icc_nocelltype$results, type == "ICC2")$"lower bound"
  icc$icc_upper = filter(icc_nocelltype$results, type == "ICC2")$"upper bound"
  icc$icc_celltype_adjusted = filter(icc_celltype$results, type == "ICC2")$ICC
  icc$icc_lower_celltype_adjusted = filter(icc_celltype$results, type == "ICC2")$"lower bound"
  icc$icc_upper_celltype_adjusted = filter(icc_celltype$results, type == "ICC2")$"upper bound"
  # append to results
  icc_epiclocks <- rbind(icc_epiclocks, icc)
}

```

# Export correlations and ICCs as table

## Append ICCs to output table

```{r}
# rename epiclocks
icc_epiclocks$name <- str_replace_all(icc_epiclocks$name,
                                              c("epiage_pc_horvath" = "PCHorvathAge",
                                                "epiage_accel_pc_horvath" = "PCHorvathAccel",
                                                "epiage_delta_pc_horvath" = "PCHorvathDelta",
                                                "epiage_horvath" = "HorvathAge",
                                                "epiage_accel_horvath" = "HorvathAccel",
                                                "epiage_delta_horvath" = "HorvathDelta",
                                                "epiage_pc_skinblood" = "PCSkinBloodAge",
                                                "epiage_accel_pc_skinblood" = "PCSkinBloodAccel",
                                                "epiage_delta_pc_skinblood" = "PCSkinBloodDelta",
                                                "epiage_skinblood" = "SkinBloodAge",
                                                "epiage_accel_skinblood" = "SkinBloodAccel",
                                                "epiage_delta_skinblood" = "SkinBloodDelta",
                                                "epiage_pc_hannum" = "PCHannumAge",
                                                "epiage_accel_pc_hannum" = "PCHannumAccel",
                                                "epiage_delta_pc_hannum" = "PCHannumDelta",
                                                "epiage_hannum" = "HannumAge",
                                                "epiage_accel_hannum" = "HannumAccel",
                                                "epiage_delta_hannum" = "HannumDelta",
                                                "epiage_pedbe" = "PedBEAge",
                                                "epiage_accel_pedbe" = "PedBEAccel",
                                                "epiage_delta_pedbe" = "PedBEDelta",
                                                "epiage_pc_phenoage" = "PCPhenoAgeAge",
                                                "epiage_accel_pc_phenoage" = "PCPhenoAgeAccel",
                                                "epiage_delta_pc_phenoage" = "PCPhenoAgeDelta",
                                                "epiage_phenoage" = "PhenoAgeAge",
                                                "epiage_accel_phenoage" = "PhenoAgeAccel",
                                                "epiage_delta_phenoage" = "PhenoAgeDelta",
                                                "epiage_wu" = "WuAge",
                                                "epiage_accel_wu" = "WuAccel",
                                                "epiage_delta_wu" = "WuDelta",
                                                "epiage_grimage2" = "GrimAge2Age",
                                                "epiage_accel_grimage2" = "GrimAge2Accel",
                                                "epiage_delta_grimage2" = "GrimAge2Delta",
                                                "epiage_pc_grimage" = "PCGrimAgeAge",
                                                "epiage_accel_pc_grimage" = "PCGrimAgeAccel",
                                                "epiage_delta_pc_grimage" = "PCGrimAgeDelta",
                                                "epiage_grimage" = "GrimAgeAge",
                                                "epiage_accel_grimage" = "GrimAgeAccel",
                                                "epiage_delta_grimage" = "GrimAgeDelta",
                                                "dunedin_pace" = "DunedinPACE"))

# append
correlations_epiclocks <- full_join(correlations_epiclocks, icc_epiclocks, join_by("epiclock" == "name"))

# round all numeric values
correlations_epiclocks <- round_values(correlations_epiclocks)

```

## Export results (eTable 5)

```{r}
# export
write_xlsx(correlations_epiclocks, path = "./05_tables_for_publication/etable_5_results_correlations_epiclocks.xlsx", col_names = TRUE, format_headers = TRUE)
```

