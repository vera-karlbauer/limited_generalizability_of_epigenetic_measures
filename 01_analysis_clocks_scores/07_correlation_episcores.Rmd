---
title: "Limited generalizability of epigenetic measures: epigenetic score cross-tissue correlations"
author: "Vera N. Karlbauer"
contact: "vera_karlbauer@psych.mpg.de"
date: "2024-12-04"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/vera_karlbauer/Documents/Kids2Health/02_stats/02_analysis/limited_generalizability_of_epigenetic_measures")
```

# What this script does:
- Correlate within-person Pearson correlations of epigenetic scores between matched blood and saliva samples.
- Calculate correlations separately for uncorrected and celltype-residualized scores.
- For all correlations, also calculate corresponding ICC values (ICC2/random effects).
- Plot results as corrplots (right side of Figure 3).
- Export results as eTable 6.

# Setup
### Step 0: Load packages

```{r, include = FALSE}
# load packages
library(rmarkdown)
library(dplyr)
library(corrplot)
library(stringr)
library(RColorBrewer)
library(tibble)
library(tidyr)
library(writexl)
library(psych)
```

### Step 1: Source functions and utilities

```{r}
source("./00_functions/01_functions.R")
source("./00_functions/02_utilities.R")
```

### Step 2: Load data

```{r, include = FALSE}
load("../../../01_data/02_proc/09_cross_tissue/all_cross_tissue_inner.Rdata")
```

### Step 3: Subset data (T0 only, scores only, with vs. without cell type correction)

```{r}
all_cross_tissue_inner <- all_cross_tissue_inner %>%
  filter(timepoint == "T0")
episcores_nocelltypes <- all_cross_tissue_inner %>%
  select(epigenetic_bmi_score_do_2023_blood,
         epigenetic_bmi_score_wahl_2017_blood,
         epigenetic_crp_score_wielscher_2022_blood,
         epigenetic_crp_score_ligthart_2016_blood,
         epigenetic_g_blood,
         epiage_telo_blood,
         epiage_pc_telo_blood,
         smoking_exposure_score_blood,
         epigenetic_bmi_score_do_2023_saliva,
         epigenetic_bmi_score_wahl_2017_saliva,
         epigenetic_crp_score_wielscher_2022_saliva,
         epigenetic_crp_score_ligthart_2016_saliva,
         epigenetic_g_saliva,
         epiage_telo_saliva,
         epiage_pc_telo_saliva,
         smoking_exposure_score_saliva)
  
episcores_celltypes <- all_cross_tissue_inner %>%
  select(epigenetic_bmi_score_do_2023_resid_blood,
         epigenetic_bmi_score_wahl_2017_resid_blood,
         epigenetic_crp_score_wielscher_2022_resid_blood,
         epigenetic_crp_score_ligthart_2016_resid_blood,
         epigenetic_g_resid_blood,
         epiage_telo_resid_blood,
         epiage_pc_telo_resid_blood,
         smoking_exposure_score_resid_blood,
         epigenetic_bmi_score_do_2023_resid_saliva,
         epigenetic_bmi_score_wahl_2017_resid_saliva,
         epigenetic_crp_score_wielscher_2022_resid_saliva,
         epigenetic_crp_score_ligthart_2016_resid_saliva,
         epigenetic_g_resid_saliva,
         epiage_telo_resid_saliva,
         epiage_pc_telo_resid_saliva,
         smoking_exposure_score_resid_saliva)
```

# Cross-tissue correlations

## Without cell type correction

### Calculate significant correlations

```{r}
# create correlation matrix
corrmat_nocelltypes <- cor(episcores_nocelltypes, use = "pairwise", method = "pearson")
# test for significance
pmat_nocelltypes <- cor.mtest(as.matrix(episcores_nocelltypes), conf.level = 0.95, method = "pearson", alternative = "two.sided", use = "pairwise", exact = FALSE)
```

## With cell type correction

### Calculate significant correlations 

```{r}
# create correlation matrix
corrmat_celltypes <- cor(episcores_celltypes, use = "pairwise", method = "pearson")
# test for significance
pmat_celltypes <- cor.mtest(as.matrix(episcores_celltypes), conf.level = 0.95, method = "pearson", alternative = "two.sided", use = "pairwise", exact = FALSE)
```

# Plot episcore correlations in "slim" format

### Format data without cell type correction

```{r}
## without cell types
# format correlation matrix diagonal into table
mat = corrmat_nocelltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_nocell <- as.matrix(diag(mat[rows, cols]))
rownames(corrmat_nocell) <- rename_scores(rows)
colnames(corrmat_nocell) <- "episcore"

# format p-value matrix diagonal into table
mat = pmat_nocelltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_nocell <- as.matrix(diag(mat[rows, cols]))
rownames(pmat_nocell) <- rownames(corrmat_nocell)
colnames(pmat_nocell) <- "episcore"
```

### Format data with cell type correction

```{r}
## without cell types
# format correlation matrix diagonal into table
mat = corrmat_celltypes
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
corrmat_cell <- as.matrix(diag(mat[rows, cols]))
rownames(corrmat_cell) <- rename_scores(rows) 
colnames(corrmat_cell) <- "episcore"

# format p-value matrix diagonal into table
mat = pmat_celltypes$p
rows <- grep("_blood$", rownames(mat), value = TRUE)
cols <- grep("_saliva$", colnames(mat), value = TRUE)
pmat_cell <- as.matrix(diag(mat[rows, cols]))
rownames(pmat_cell) <- rownames(corrmat_cell)
colnames(pmat_cell) <- "episcore"
```

### Create combined correlation plot (Figure 3B)

```{r}
# initialize graphics device
tiff(file = "04_figures/figure_3b_corrplot_all_episcores_cross_tissue.png", height = 6.7, width = 5, units = 'in', res = 700)
par(mfrow=c(1,2),
    mar = c(1,1,1,1),
    oma = c(0,0,4,0))
# Plot 1: without cell types
par(xpd=TRUE)
corrplot(corr = corrmat_nocell,
         method = "color",
         type = "full",
         col = GyPr_palette,
         addCoef.col = "black",
         tl.col = "black",
         tl.cex = 1,
         tl.srt = 45,
         number.cex = 1,
         cl.pos = "n",
         p.mat = pmat_nocell,
         sig.level = 0.05,
         insig = "label_sig",
         pch = "       *",
         pch.col = "orange",
         pch.cex = 1.2,
         na.label = "NA",
         mar = c(0,0.2,0,1))
mtext("B               Blood-saliva correlations per score", side=3, line=3, at = 1.5, cex = 1.2, font = 2)
mtext("without cell type correction", side=3, line=1, cex = 1, at = 0)
# Plot 2: with cell types
par(xpd=TRUE)
corrplot(corr = corrmat_cell,
         method = "color",
         type = "full",
         col = GyPr_palette,
         addCoef.col = "black",
         tl.col = "black",
         tl.cex = 1,
         tl.srt = 45,
         number.cex = 1,
         cl.pos = "n",
         p.mat = pmat_cell,
         sig.level = 0.05,
         insig = "label_sig",
         pch = "       *",
         pch.col = "orange",
         pch.cex = 1.2,
         na.label = "NA", 
         mar = c(0,0.2,0,1))
mtext("with cell type correction", side=3, line=1, cex = 1, at = 0)

# shut off
dev.off()
```

## Prepare correlations for export & correct for multiple testing

```{r}
# reshape
# corrmat_nocell
corrmat_nocell <- as.data.frame(corrmat_nocell)
colnames(corrmat_nocell) <- "cor"
corrmat_nocell <- corrmat_nocell %>%
  rownames_to_column(var = "episcore")
# pmat_nocell
pmat_nocell <- as.data.frame(pmat_nocell)
colnames(pmat_nocell) <- "p"
pmat_nocell <- pmat_nocell %>%
  rownames_to_column(var = "episcore")
# corrmat_cell
corrmat_cell <- as.data.frame(corrmat_cell) 
colnames(corrmat_cell) <- "cor_celltype_adjusted"
corrmat_cell <- corrmat_cell %>%
  rownames_to_column(var = "episcore")
# pmat_cell
pmat_cell <- as.data.frame(pmat_cell) 
colnames(pmat_cell) <- "p_celltype_adjusted"
pmat_cell <- pmat_cell %>%
  rownames_to_column(var = "episcore")

# combine 
correlations_episcores <- full_join(corrmat_nocell, pmat_nocell, by = "episcore")
correlations_episcores <- full_join(correlations_episcores, corrmat_cell, by = "episcore")
correlations_episcores <- full_join(correlations_episcores, pmat_cell, by = "episcore")

# run FDR correction
correlations_episcores <- correlations_episcores %>%
  mutate(p_fdr = p.adjust(
    c(correlations_episcores$p, correlations_episcores$p_celltype_adjusted), 
    method = "fdr")[1:length(correlations_episcores$p)],
         p_fdr_celltype_adjusted = p.adjust(
           c(correlations_episcores$p, correlations_episcores$p_celltype_adjusted),
           method = "fdr")[(length(correlations_episcores$p)+1):(2*length(correlations_episcores$p_celltype_adjusted))])

```

# Calculate cross-tissue ICCs of scores estimates

```{r}
# get names of all epigenetic aging measures
scorenames <- unique(gsub("_saliva", "", gsub("_blood", "", colnames(episcores_nocelltypes))))
  
# define empty results object
icc_episcores <- as.data.frame(matrix(nrow = 7, ncol = 0))
# loop over all episcores measures
# for each episcore, calculate ICC2 (random effects) with and without cell type correction
for(i in 1:length(scorenames)) {
  score = scorenames[i]
  icc_nocelltype = ICC(select(all_cross_tissue_inner, 
                        paste0(score, "_blood"), paste0(score, "_saliva")))
  icc_celltype = ICC(select(all_cross_tissue_inner,
                            paste0(score, "_resid_blood"), paste0(score, "_resid_saliva")))
  icc = as.data.frame(matrix(nrow = 1, ncol = 0))
  icc$name = score
  icc$icc = filter(icc_nocelltype$results, type == "ICC2")$ICC
  icc$icc_lower = filter(icc_nocelltype$results, type == "ICC2")$"lower bound"
  icc$icc_upper = filter(icc_nocelltype$results, type == "ICC2")$"upper bound"
  icc$icc_celltype_adjusted = filter(icc_celltype$results, type == "ICC2")$ICC
  icc$icc_lower_celltype_adjusted = filter(icc_celltype$results, type == "ICC2")$"lower bound"
  icc$icc_upper_celltype_adjusted = filter(icc_celltype$results, type == "ICC2")$"upper bound"
  # append to results
  icc_episcores <- rbind(icc_episcores, icc)
}

```


# Export correlations and ICCs as table

## Append ICCs to output table
```{r}
# rename episcores
icc_episcores$name <- str_replace_all(icc_episcores$name,
                                              c("epigenetic_bmi_score_do_2023" = "BMI (Do, 2023)",
                                              "epigenetic_bmi_score_wahl_2017" = "BMI (Wahl, 2017)",
                                              "epigenetic_crp_score_ligthart_2016" = "CRP (Ligthart, 2016)",
                                              "epigenetic_crp_score_wielscher_2022" = "CRP (Wielscher, 2022)",
                                              "epigenetic_g" = "Epigenetic-g",
                                              "epiage_pc_telo" = "PC DNAmTL",
                                              "epiage_telo" = "DNAmTL",
                                              "smoking_exposure_score" = "Smoking exposure"
                                              ))

# append
correlations_episcores <- full_join(correlations_episcores, icc_episcores, join_by("episcore" == "name"))

# round all numeric values to 4 digits
correlations_episcores <- round_values(correlations_episcores)

```

## Export (eTable 6)

```{r}
# export
write_xlsx(correlations_episcores, path = "05_tables_for_publication/etable_6_results_correlations_episcores.xlsx", col_names = TRUE, format_headers = TRUE)
```

